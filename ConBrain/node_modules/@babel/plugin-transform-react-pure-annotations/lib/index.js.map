{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { declare } from \"@babel/helper-plugin-utils\";\nimport annotateAsPure from \"@babel/helper-annotate-as-pure\";\nimport { types as t } from \"@babel/core\";\nimport type { NodePath } from \"@babel/traverse\";\n\n// Mapping of React top-level methods that are pure.\n// This plugin adds a /*#__PURE__#/ annotation to calls to these methods,\n// so that terser and other minifiers can safely remove them during dead\n// code elimination.\n// See https://reactjs.org/docs/react-api.html\nconst PURE_CALLS: [string, Set<string>][] = [\n  [\n    \"react\",\n    new Set([\n      \"cloneElement\",\n      \"createContext\",\n      \"createElement\",\n      \"createFactory\",\n      \"createRef\",\n      \"forwardRef\",\n      \"isValidElement\",\n      \"memo\",\n      \"lazy\",\n    ]),\n  ],\n  [\"react-dom\", new Set([\"createPortal\"])],\n];\n\nexport default declare(api => {\n  api.assertVersion(\n    process.env.BABEL_8_BREAKING && process.env.IS_PUBLISH\n      ? PACKAGE_JSON.version\n      : 7,\n  );\n\n  return {\n    name: \"transform-react-pure-annotations\",\n    visitor: {\n      CallExpression(path) {\n        if (isReactCall(path)) {\n          annotateAsPure(path);\n        }\n      },\n    },\n  };\n});\n\nfunction isReactCall(path: NodePath<t.CallExpression>) {\n  // If the callee is not a member expression, then check if it matches\n  // a named import, e.g. `import {forwardRef} from 'react'`.\n  const calleePath = path.get(\"callee\");\n  if (!calleePath.isMemberExpression()) {\n    for (const [module, methods] of PURE_CALLS) {\n      for (const method of methods) {\n        if (calleePath.referencesImport(module, method)) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  // Otherwise, check if the member expression's object matches\n  // a default import (`import React from 'react'`) or namespace\n  // import (`import * as React from 'react'), and check if the\n  // property matches one of the pure methods.\n  const object = calleePath.get(\"object\");\n  const callee = calleePath.node;\n  if (!callee.computed && t.isIdentifier(callee.property)) {\n    const propertyName = callee.property.name;\n    for (const [module, methods] of PURE_CALLS) {\n      if (\n        object.referencesImport(module, \"default\") ||\n        object.referencesImport(module, \"*\")\n      ) {\n        return methods.has(propertyName);\n      }\n    }\n  }\n\n  return false;\n}\n"],"names":["PURE_CALLS","Set","declare","api","assertVersion","name","visitor","CallExpression","path","isReactCall","annotateAsPure","calleePath","get","isMemberExpression","module","methods","method","referencesImport","object","callee","node","computed","t","isIdentifier","property","propertyName","has"],"mappings":";;;;AAUA,MAAMA,UAAmC,GAAG,CAC1C,CACE,OAAO,EACP,IAAIC,GAAG,CAAC,CACN,cAAc,EACd,eAAe,EACf,eAAe,EACf,eAAe,EACf,WAAW,EACX,YAAY,EACZ,gBAAgB,EAChB,MAAM,EACN,MAAM,CACP,CAAC,CACH,EACD,CAAC,WAAW,EAAE,IAAIA,GAAG,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,CACzC,CAAA;AAED,YAAeC,OAAO,CAACC,GAAG,IAAI;EAC5BA,GAAG,CAACC,aAAa,CAAA,eAIjB,CAAC,CAAA;EAED,OAAO;AACLC,IAAAA,IAAI,EAAE,kCAAkC;AACxCC,IAAAA,OAAO,EAAE;MACPC,cAAcA,CAACC,IAAI,EAAE;AACnB,QAAA,IAAIC,WAAW,CAACD,IAAI,CAAC,EAAE;UACrBE,cAAc,CAACF,IAAI,CAAC,CAAA;AACtB,SAAA;AACF,OAAA;AACF,KAAA;GACD,CAAA;AACH,CAAC,CAAC,CAAA;AAEF,SAASC,WAAWA,CAACD,IAAgC,EAAE;AAGrD,EAAA,MAAMG,UAAU,GAAGH,IAAI,CAACI,GAAG,CAAC,QAAQ,CAAC,CAAA;AACrC,EAAA,IAAI,CAACD,UAAU,CAACE,kBAAkB,EAAE,EAAE;IACpC,KAAK,MAAM,CAACC,MAAM,EAAEC,OAAO,CAAC,IAAIf,UAAU,EAAE;AAC1C,MAAA,KAAK,MAAMgB,MAAM,IAAID,OAAO,EAAE;QAC5B,IAAIJ,UAAU,CAACM,gBAAgB,CAACH,MAAM,EAAEE,MAAM,CAAC,EAAE;AAC/C,UAAA,OAAO,IAAI,CAAA;AACb,SAAA;AACF,OAAA;AACF,KAAA;AAEA,IAAA,OAAO,KAAK,CAAA;AACd,GAAA;AAMA,EAAA,MAAME,MAAM,GAAGP,UAAU,CAACC,GAAG,CAAC,QAAQ,CAAC,CAAA;AACvC,EAAA,MAAMO,MAAM,GAAGR,UAAU,CAACS,IAAI,CAAA;AAC9B,EAAA,IAAI,CAACD,MAAM,CAACE,QAAQ,IAAIC,KAAC,CAACC,YAAY,CAACJ,MAAM,CAACK,QAAQ,CAAC,EAAE;AACvD,IAAA,MAAMC,YAAY,GAAGN,MAAM,CAACK,QAAQ,CAACnB,IAAI,CAAA;IACzC,KAAK,MAAM,CAACS,MAAM,EAAEC,OAAO,CAAC,IAAIf,UAAU,EAAE;AAC1C,MAAA,IACEkB,MAAM,CAACD,gBAAgB,CAACH,MAAM,EAAE,SAAS,CAAC,IAC1CI,MAAM,CAACD,gBAAgB,CAACH,MAAM,EAAE,GAAG,CAAC,EACpC;AACA,QAAA,OAAOC,OAAO,CAACW,GAAG,CAACD,YAAY,CAAC,CAAA;AAClC,OAAA;AACF,KAAA;AACF,GAAA;AAEA,EAAA,OAAO,KAAK,CAAA;AACd;;;;"}